# Wiki RAG (База знаний)

Система контекстного поиска по документации с автоматической инжекцией в системный промпт LLM.

## Скриншот

<!-- Вставьте скриншот страницы Wiki RAG -->
![Wiki RAG](images/wiki-rag.png)

## Концепция

Wiki RAG — это TF-IDF поисковая система по markdown-документам, встроенная в ИИ-секретаря:
- Автоматически индексирует все файлы `.md` из каталога `wiki-pages/`
- Разбивает документы на секции по заголовкам `##` и `###`
- Строит инвертированный индекс с поддержкой **кириллицы**
- При запросе к LLM автоматически инжектит релевантные секции документации в системный промпт
- **Нулевые зависимости** — чистый Python, без GPU, без внешних библиотек

## Как это работает

### Индексация

```
1. Парсинг markdown по заголовкам ## и ###
2. Токенизация текста (Unicode-aware, русский + английский)
3. Фильтрация стоп-слов (русские + английские)
4. Построение TF-IDF индекса
5. Токены из заголовков получают 2x вес
```

### Фильтрация

| Параметр | Значение |
|----------|----------|
| **MIN_TOKEN_LEN** | 2 символа |
| **Минимальная длина секции** | 50 символов (короткие игнорируются) |
| **Стоп-слова** | Фильтруются для русского и английского |

### Поиск

```
1. Пользователь отправляет запрос LLM
2. Wiki RAG токенизирует запрос
3. TF-IDF ранжирование → топ-k секций
4. Форматирование в markdown-контекст
5. Инжекция в начало системного промпта
6. LLM отвечает с учётом найденной документации
```

## Управление документами

Левая панель отображает все документы в базе:

| Элемент | Описание |
|---------|----------|
| **Название** | Имя файла или title из метаданных |
| **Секций** | Количество индексированных секций |
| **Токенов** | Уникальные токены |
| **Источник** | `source_file` (относительный путь) |
| **Действия** | Просмотр / Редактировать / Удалить |

### Загрузка документа

1. Нажмите **"Загрузить документ"**
2. Выберите файл `.md` или `.txt`
3. Документ сохраняется в `wiki-pages/` и индексируется автоматически

### Синхронизация с диском

При первом обращении к API система автоматически сканирует `wiki-pages/`:
- Новые файлы на диске → добавляются в БД
- Файлы в БД, но отсутствующие на диске → помечаются как недоступные
- Изменённые файлы (по timestamp) → переиндексируются

### Редактирование

1. Выберите документ из списка
2. Откройте редактор (markdown)
3. Сохраните — индекс обновится автоматически

### Удаление

Удаление документа:
- **Из БД** — запись удаляется
- **С диска** — файл удаляется физически из `wiki-pages/`

## Поиск и контекст

### Поиск (Search)

API: `POST /admin/wiki-rag/search`

```json
{
  "query": "как настроить telegram бота",
  "top_k": 5
}
```

Результат:

```json
{
  "results": [
    {
      "title": "Telegram (Telegram боты)",
      "body": "Настройка мультиинстансных Telegram-ботов...",
      "source_file": "wiki-pages/Telegram.md",
      "score": 0.87
    }
  ],
  "query": "как настроить telegram бота",
  "found": 5
}
```

### Контекст (Retrieve)

API: `POST /admin/wiki-rag/retrieve`

```json
{
  "query": "telegram webhook",
  "max_chars": 1500
}
```

Возвращает отформатированный markdown-контекст для инжекции в системный промпт:

```markdown
# Релевантная документация

## Telegram (Telegram боты)
Настройка Telegram-ботов через webhook или long polling...

## Payments (Платежи)
YooMoney webhook принимает POST /webhooks/yoomoney...
```

## Статистика и перезагрузка

### Статистика

API: `GET /admin/wiki-rag/stats`

```json
{
  "available": true,
  "sections_indexed": 248,
  "files_indexed": 15,
  "unique_tokens": 3420
}
```

### Перезагрузка индекса

API: `POST /admin/wiki-rag/reload`

Пересканирует все файлы в `wiki-pages/` и перестраивает индекс.

## API эндпоинты

### Управление системой

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/admin/wiki-rag/stats` | Статистика индекса |
| POST | `/admin/wiki-rag/reload` | Перестроить индекс |
| POST | `/admin/wiki-rag/search` | Поиск по запросу |
| POST | `/admin/wiki-rag/retrieve` | Получить контекст для промпта |

### Управление документами

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/admin/wiki-rag/documents` | Список всех документов |
| POST | `/admin/wiki-rag/documents/upload` | Загрузить `.md` или `.txt` |
| GET | `/admin/wiki-rag/documents/{id}` | Просмотр документа |
| PUT | `/admin/wiki-rag/documents/{id}` | Редактировать документ |
| DELETE | `/admin/wiki-rag/documents/{id}` | Удалить документ |

## RBAC

- **Admin** — полный доступ (загрузка, редактирование, удаление)
- **User/Web** — загрузка, редактирование и удаление своих документов
- **Guest** — только чтение и поиск

## Технические детали

### Токенизация

- **Unicode-aware** — корректно обрабатывает кириллицу
- **Case-insensitive** — приведение к нижнему регистру
- **Разделители** — пробелы и знаки пунктуации

### TF-IDF формула

```
TF-IDF(t, d) = TF(t, d) * IDF(t)

TF(t, d) = (частота токена t в секции d) / (всего токенов в d)
IDF(t) = log(N / df(t))
    N = всего секций
    df(t) = в скольких секциях встречается токен t
```

### Вес заголовков

Токены из `title` секции добавляются в индекс **дважды**, удваивая их TF-вес.

### Производительность

- **Индексация** — ~1000 секций/сек
- **Поиск** — <10ms для запроса из 5-10 токенов
- **Память** — ~50KB на 1000 секций

## Интеграция с LLM

Когда включена функция Wiki RAG:

```
1. Пользователь: "Как настроить webhook для Telegram?"
2. Wiki RAG → retrieve("telegram webhook", max_chars=1500)
3. Системный промпт LLM:
   ---
   # Релевантная документация
   <найденные секции>
   ---
   <стандартный system_prompt>
4. LLM отвечает с учётом документации
```

## Примеры использования

### Документация продукта

Загрузите всю техническую документацию в `wiki-pages/` → ИИ-секретарь будет отвечать на вопросы клиентов, ссылаясь на актуальную документацию.

### База знаний компании

Загрузите регламенты, инструкции, FAQ → боты в Telegram и виджеты на сайте смогут давать точные ответы.

### Обучение персонала

Новые сотрудники задают вопросы ИИ-ассистенту, который ищет информацию в корпоративной wiki.

---

← [[FAQ]] | [[Personas]] →
