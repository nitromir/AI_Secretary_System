# Chat (Чат)

Полнофункциональный чат с ИИ-ассистентом: стриминг, голосовой ввод/вывод, ветвление диалогов (branching), управление сессиями.

## Основные функции

### Чат с ИИ

- **Стриминг** — ответы появляются посимвольно через SSE (`POST /admin/chat/sessions/{id}/stream`)
- **Markdown** — полная поддержка разметки (код с подсветкой, таблицы, списки)
- **Контекст** — вся активная история сессии передаётся LLM
- **Автоматический заголовок** — первое сообщение становится названием сессии

### Голосовые функции

| Функция | Описание | Активация |
|---------|----------|-----------|
| **Voice Mode** | Автоматическое озвучивание каждого ответа ИИ | Кнопка в заголовке |
| **TTS** | Ручное озвучивание конкретного ответа | Кнопка на сообщении |
| **STT** | Голосовой ввод через микрофон (Vosk/Whisper) | Кнопка микрофона |

### Выбор LLM провайдера

Выпадающий список в заголовке чата позволяет переключать LLM на лету:

- **Системный** — использует глобальную настройку из LLM
- **vLLM** — локальная модель (Qwen/Llama/DeepSeek)
- **Cloud providers** — любой настроенный облачный провайдер (Gemini, Claude, OpenAI и др.)

Смена провайдера не влияет на глобальные настройки — только на текущую сессию.

## Ветвление диалогов (Branching)

Система ветвления в стиле OpenWebUI — не-деструктивное редактирование и регенерация ответов.

### Как работает

Каждое сообщение (`ChatMessage`) имеет:
- `parent_id` — ссылка на родительское сообщение
- `is_active` — активна ли эта версия

### Редактирование сообщения

1. Нажмите иконку редактирования на сообщении
2. Измените текст → Отправить
3. Старая версия деактивируется (`is_active=False`), создаётся новый sibling
4. ИИ генерирует новый ответ на отредактированное сообщение

### Регенерация ответа

1. Нажмите иконку регенерации на ответе ИИ
2. Старый ответ деактивируется, генерируется новый
3. Все предыдущие версии сохраняются

### Навигация по версиям

- Сообщения с альтернативами показывают переключатель `< 1/3 >`
- **BranchTree** — панель справа с деревом всех веток сессии
- Переключение ветки активирует выбранную версию и всех её потомков

### API ветвления

| Endpoint | Описание |
|----------|----------|
| `PUT /admin/chat/sessions/{id}/messages/{msg_id}` | Не-деструктивное редактирование (создаёт sibling) |
| `POST /admin/chat/sessions/{id}/messages/{msg_id}/regenerate` | Регенерация ответа |
| `GET /admin/chat/sessions/{id}/branches` | Дерево веток |
| `POST /admin/chat/sessions/{id}/branches/switch` | Переключить активную ветку |

## Управление сессиями

### Боковая панель

- **Список чатов** — все сессии с превью последнего сообщения
- **Создание** — кнопка "+" создаёт новую сессию
- **Поиск** — фильтрация по названию
- **Группировка** — по источнику (`?group_by=source`):
  - **Админ-панель** — чаты из этого интерфейса
  - **Telegram** — чаты из Telegram ботов
  - **Widget** — чаты из веб-виджетов

### Действия с чатами

| Действие | Как |
|----------|-----|
| **Переименование** | Двойной клик → редактирование → Enter |
| **Удаление** | Иконка корзины |
| **Групповое удаление** | Режим выбора → отметить → `POST /admin/chat/sessions/bulk-delete` |
| **Редактирование промпта** | Кнопка ⚙️ → изменить system prompt сессии |

## Системный промпт

Промпт сессии определяется по приоритету:
1. Кастомный промпт сессии (если задан через ⚙️)
2. Промпт персоны (Anna/Marina)
3. Код-fallback по умолчанию

Плюс Wiki RAG контекст добавляется автоматически (если Wiki RAG инициализирован).

## API

| Endpoint | Описание |
|----------|----------|
| `GET /admin/chat/sessions` | Список сессий (с group_by и owner фильтрацией) |
| `POST /admin/chat/sessions` | Создать сессию (с source tracking) |
| `GET /admin/chat/sessions/{id}` | Получить сессию с сообщениями и sibling_info |
| `PUT /admin/chat/sessions/{id}` | Обновить (переименовать, сменить промпт) |
| `DELETE /admin/chat/sessions/{id}` | Удалить сессию |
| `POST /admin/chat/sessions/bulk-delete` | Массовое удаление |
| `POST /admin/chat/sessions/{id}/messages` | Отправить сообщение (без стриминга) |
| `POST /admin/chat/sessions/{id}/stream` | SSE стриминг ответа |
| `DELETE /admin/chat/sessions/{id}/messages/{msg_id}` | Удалить сообщение |

## Горячие клавиши

| Клавиша | Действие |
|---------|----------|
| `Enter` | Отправить сообщение |
| `Shift+Enter` | Новая строка |
| `Esc` | Отмена редактирования |
| `Ctrl+K` / `⌘K` | Command Palette |

---

← [[Dashboard]] | [[Services]] →
