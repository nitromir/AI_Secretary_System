# CRM (amoCRM)

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å amoCRM v4 API: OAuth2 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –ª–∏–¥–æ–≤ –∏ –∑–∞–¥–∞—á, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫.

## –°–∫—Ä–∏–Ω—à–æ—Ç

<!-- –í—Å—Ç–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã CRM -->
![CRM](images/crm.png)

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **amoCRM v4 API** —á–µ—Ä–µ–∑ OAuth2 —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- **–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –∏–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –ª–∏–¥–æ–≤ –∏–∑ amoCRM ‚Üí —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–æ—Ç–∞ –≤ CRM
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫**: –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –≤ Telegram –±–æ—Ç –∏–ª–∏ –≤–∏–¥–∂–µ—Ç
- **Webhook-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –æ—Ç amoCRM (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, —Å–¥–µ–ª–æ–∫, –∑–∞–¥–∞—á)
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–æ–Ω–∫–∞–º–∏**: –≤—ã–±–æ—Ä pipeline –∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤
- **Docker/VPN proxy**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

## –°—Ç—Ä–∞–Ω–∏—Ü–∞ CRM

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ `CrmView.vue` —Å –≤–∫–ª–∞–¥–∫–∞–º–∏/—Å–µ–∫—Ü–∏—è–º–∏:

### Connection Status (–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)

| –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ | OAuth2 —Ç–æ–∫–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã, –∞–∫–∫–∞—É–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω |
| üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ | –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∏ |
| üü° –û—à–∏–±–∫–∞ | –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∑–∞–ø—Ä–æ—Å–µ |

### Settings Form (–ù–∞—Å—Ç—Ä–æ–π–∫–∏)

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| **Subdomain** | –ü–æ–¥–¥–æ–º–µ–Ω amoCRM (–Ω–∞–ø—Ä–∏–º–µ—Ä, `mycompany` –¥–ª—è `mycompany.amocrm.ru`) |
| **Client ID** | OAuth2 Client ID –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
| **Client Secret** | OAuth2 Client Secret |
| **Redirect URI** | URI –¥–ª—è OAuth callback (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è: `https://yourdomain.com/admin/crm/callback`) |
| **Sync Contacts** | –í–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ |
| **Sync Leads** | –í–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ª–∏–¥–æ–≤ |
| **Sync Tasks** | –í–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á |
| **Auto Create Lead** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ |
| **Lead Pipeline ID** | ID –≤–æ—Ä–æ–Ω–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤ |
| **Lead Status ID** | ID —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤ |

### OAuth2 Flow

#### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ amoCRM

1. –ó–∞–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é**
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø **Private app** (–¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞) –∏–ª–∏ **OAuth2** (–¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Client ID** –∏ **Client Secret**
4. –£–∫–∞–∂–∏—Ç–µ **Redirect URI**: `https://yourdomain.com/admin/crm/callback`
5. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (scope): `crm` (–∫–æ–Ω—Ç–∞–∫—Ç—ã, —Å–¥–µ–ª–∫–∏, –∑–∞–¥–∞—á–∏)

#### –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

1. –í—Å—Ç–∞–≤—å—Ç–µ **Subdomain**, **Client ID** –∏ **Client Secret** –≤ —Ñ–æ—Ä–º—É
2. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ª—É—á–∏—Ç—å URL –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"** ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ **"–ü–æ–¥–∫–ª—é—á–∏—Ç—å amoCRM"**
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Üí –æ—Ç–∫—Ä–æ–µ—Ç—Å—è popup —Å OAuth-—Å—Ç—Ä–∞–Ω–∏—Ü–µ–π amoCRM
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ amoCRM
5. –ü–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∏—Ç —Ç–æ–∫–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç —Å—Ç–∞—Ç—É—Å **"–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"**

#### –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–±–µ–∑ OAuth redirect)

–î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π amoCRM –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (`authorization_code`) –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ amoCRM
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ **"–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥"**
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤–º–µ—Å—Ç–æ OAuth2 flow
4. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–º–µ–Ω—è–µ—Ç –∫–æ–¥ –Ω–∞ —Ç–æ–∫–µ–Ω—ã

### Account Info (–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ)

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| **Account Name** | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| **Subdomain** | –ü–æ–¥–¥–æ–º–µ–Ω |
| **User Name** | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **User Email** | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### Sync Controls (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π)

| –ö–Ω–æ–ø–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|
| **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å** | –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤/–ª–∏–¥–æ–≤ |
| **–û—Ç–∫–ª—é—á–∏—Ç—å** | –û—Ç–æ–∑–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã OAuth2 |

### Sync Log (–õ–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)

–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| **Timestamp** | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è |
| **Operation** | –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (`sync_contacts`, `sync_leads`, `create_lead`) |
| **Status** | –°—Ç–∞—Ç—É—Å (`success`, `error`) |
| **Details** | –î–µ—Ç–∞–ª–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –æ—à–∏–±–∫–∏) |

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| **Contacts Count** | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ amoCRM |
| **Leads Count** | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ |
| **Last Sync Time** | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |

## Docker/VPN Proxy

–ï—Å–ª–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ amoCRM (–Ω–∞–ø—Ä–∏–º–µ—Ä, VPN –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ö–æ—Å—Ç–µ), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏:

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ö–æ—Å—Ç–µ

```bash
python scripts/amocrm_proxy.py
```

–ü—Ä–æ–∫—Å–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É `8888` –∏ –ø—Ä–æ–±—Ä–æ—Å–∏—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ amoCRM.

### –®–∞–≥ 2: –£–∫–∞–∑–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –≤ Docker

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```bash
AMOCRM_PROXY=http://172.17.0.1:8888
```

–ì–¥–µ `172.17.0.1` ‚Äî IP —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—ã –∏–∑ Docker-—Å–µ—Ç–∏.

## Webhook

Endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ç amoCRM: **`POST /webhooks/amocrm`**

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ amoCRM

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –í–µ–±—Ö—É–∫–∏**
2. –£–∫–∞–∂–∏—Ç–µ URL: `https://yourdomain.com/webhooks/amocrm`
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è: `add`, `update`, `delete` –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, —Å–¥–µ–ª–æ–∫, –∑–∞–¥–∞—á
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `contacts:add` | –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç–∞–∫—Ç |
| `contacts:update` | –û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–Ω—Ç–∞–∫—Ç |
| `leads:add` | –°–æ–∑–¥–∞–Ω–∞ —Å–¥–µ–ª–∫–∞ |
| `leads:update` | –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–¥–µ–ª–∫–∞ |
| `leads:status` | –ò–∑–º–µ–Ω—ë–Ω —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ |
| `tasks:add` | –°–æ–∑–¥–∞–Ω–∞ –∑–∞–¥–∞—á–∞ |
| `tasks:update` | –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞ |

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–æ–≤

–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ **Auto Create Lead**, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ –≤–∏–¥–∂–µ—Ç–∞:

1. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç —Å —ç—Ç–∏–º Telegram User ID
2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–∞–∫—Ç
3. –°–æ–∑–¥–∞—ë—Ç —Å–¥–µ–ª–∫—É (–ª–∏–¥) –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤–æ—Ä–æ–Ω–∫–µ (`Lead Pipeline ID`) –∏ —Å—Ç–∞—Ç—É—Å–µ (`Lead Status ID`)
4. –°–≤—è–∑—ã–≤–∞–µ—Ç —Å–¥–µ–ª–∫—É —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/admin/crm/config` | –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é CRM |
| PUT | `/admin/crm/config` | –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é |
| GET | `/admin/crm/auth-url` | –ü–æ–ª—É—á–∏—Ç—å URL –¥–ª—è OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ |
| GET | `/admin/crm/callback` | OAuth2 callback (–æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã) |
| GET | `/admin/crm/status` | –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Ç–æ–∫–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã?) |
| POST | `/admin/crm/disconnect` | –û—Ç–∫–ª—é—á–∏—Ç—å amoCRM (–æ—Ç–æ–∑–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã) |
| GET | `/admin/crm/contacts` | –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ amoCRM |
| GET | `/admin/crm/leads` | –°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫ –∏–∑ amoCRM |
| GET | `/admin/crm/pipelines` | –°–ø–∏—Å–æ–∫ –≤–æ—Ä–æ–Ω–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ |
| POST | `/admin/crm/sync` | –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é |
| GET | `/admin/crm/sync/log` | –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| GET | `/admin/crm/account` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ |

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã

```http
GET /admin/crm/contacts?limit=50&offset=0
Authorization: Bearer <jwt_token>
```

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

```json
{
  "_embedded": {
    "contacts": [
      {
        "id": 12345,
        "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
        "custom_fields_values": [
          {
            "field_code": "PHONE",
            "values": [{"value": "+79001234567"}]
          },
          {
            "field_code": "EMAIL",
            "values": [{"value": "ivan@example.com"}]
          }
        ]
      }
    ]
  }
}
```

## Error Handling (–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)

### AmoCRMAPIError

–û–±—â–∞—è –æ—à–∏–±–∫–∞ API amoCRM:

```python
raise AmoCRMAPIError(f"API error: {response.status_code}")
```

### AmoCRMTokenExpired

–ò—Å—Ç—ë–∫ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (401):

```python
raise AmoCRMTokenExpired("Access token expired")
```

–°–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å.

### Rate Limiting (429)

–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (429 Too Many Requests):

- –ú–∞–∫—Å–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–æ–≤: **3** (`MAX_429_RETRIES`)
- –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–∞–º–∏: **1.5 —Å–µ–∫—É–Ω–¥—ã** (`RETRY_DELAY_SECONDS`)
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff

```python
if response.status_code == 429 and retry_count < MAX_429_RETRIES:
    await asyncio.sleep(RETRY_DELAY_SECONDS * (retry_count + 1))
    return await self._request(...)
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```
app/routers/amocrm.py
  ‚Üí app/services/amocrm_service.py (AmoCRMService)
    ‚Üí AsyncAmoCRMManager (db/integration.py)
      ‚Üí AmoCRMRepository (db/repositories/amocrm.py)
        ‚Üí AmoCRMConfig, AmoCRMToken (db/models.py)
```

### AmoCRMService

–ß–∏—Å—Ç—ã–π async HTTP-–∫–ª–∏–µ–Ω—Ç **–±–µ–∑ –ø—Ä—è–º–æ–≥–æ DB-–¥–æ—Å—Ç—É–ø–∞**. –ú–µ—Ç–æ–¥—ã:

- `get_contacts(limit, offset)` ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- `get_leads(limit, offset)` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫
- `create_lead(name, price, pipeline_id, status_id, contact_id)` ‚Äî —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
- `get_pipelines()` ‚Äî —Å–ø–∏—Å–æ–∫ –≤–æ—Ä–æ–Ω–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- `refresh_tokens()` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ 401
- `exchange_code(code)` ‚Äî –æ–±–º–µ–Ω `authorization_code` –Ω–∞ —Ç–æ–∫–µ–Ω—ã

### AsyncAmoCRMManager

–ú–µ–Ω–µ–¥–∂–µ—Ä –≤ `db/integration.py` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –ë–î:

- `get_config()` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- `save_config(config)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- `get_tokens()` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
- `save_tokens(tokens)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
- `delete_tokens()` ‚Äî —É–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ)

### Proxy Support

–ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è **`AMOCRM_PROXY`**, –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç—Å—è:

```python
proxies = {"http://": os.getenv("AMOCRM_PROXY"), "https://": os.getenv("AMOCRM_PROXY")}
async with httpx.AsyncClient(proxies=proxies) as client:
    response = await client.get(url)
```

## RBAC

- **Admin** ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ CRM-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **User** ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–æ `owner_id`)
- **Guest** ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ

---

‚Üê [[Sales]] | [[Usage]] ‚Üí
